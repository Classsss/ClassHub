@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@using ClassHub.Shared

<WeekPicker weekValue="@selectedWeek" ValueChanged="OnWeekChanged" allowMultipleSelection=true/>
<br />

<div class="d-flex justify-content-between mb-2">
    <div class="d-flex align-items-center">
        <input type="text" class="form-control me-2" placeholder="제목">
        <button style="width: 40px; height: 40px; border: 0;" class="oi oi-magnifying-glass"></button>
    </div>
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th style="width: 10%;" @onclick="@(() => SortById())">번호 <i class=@((sortByIDAscending) ? "oi oi-sort-ascending" : "oi oi-sort-descending") /></th>
            <th style="width: 10%;">주차</th>
            <th style="width: 50%;">제목</th>
            <th style="width: 10%;">작성자</th>
            <th style="width: 10%;" >게시일</th>
            <th style="width: 10%;">조회</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var lec_mat in paged_lec_mats)
        {
            @if (selectedWeek.Contains(lec_mat.week))
            {
                <tr class="matlec-row" @onclick="@(() => ShowLecMat(lec_mat))" style="cursor:pointer;">
                    <td style="text-indent : 7px;">@lec_mat.content_id</td>
                    <td style="text-indent : 7px;">@lec_mat.week</td>
                    <td class="notice-title">@lec_mat.title</td>
                    <td>@lec_mat.author</td>
                    <td>@lec_mat.publish_date.ToString("yyyy.MM.dd")</td>
                    <td style="text-indent : 7px;">@lec_mat.view_count</td>
                </tr>
            }
        }
    </tbody>
</table>

<AuthorizeView Roles="professor">
    <div class="row">
        <div class="col-12">
            <button class="btn btn-success float-end"@onclick="@(() => OpenEditor())">등록</button>
        </div>
    </div>
</AuthorizeView>

<Pagination currentPage="currentPage" totalPages="totalPages" onPageChanged="OnPageChanged"></Pagination>

<style>
    .matlec-row:hover {
        background-color: rgba(0, 0, 0, 0.1);
    }

    .matlec-title:hover {
        color: #007bff;
        text-decoration: underline;
    }
</style>

@code {
    [Parameter]
    public List<LectureMaterial> lecture_materials { get; set; }

    private List<LectureMaterial> paged_lec_mats = new List<LectureMaterial>();

    [Parameter]
    public EventCallback<List<int>> ViewChanged { get; set; } //Week 값 변경 시 발생하는 콜백이벤트

    private int currentPage = 1;
    private int pageSize = 10; // 원하는 페이지당 표시할 항목 수를 설정합니다.
    private int totalPages = 0;

    public List<int> selectedWeek = new List<int>() { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14 };

    public int RoomId { get; set; }

    //정렬을 위한 변수
    private bool sortByIDAscending = true;

    // 페이지가 초기화되면 실행(페이지 진입, 새로고침, 공지보고오기 등)
    protected override async void OnInitialized()
    {
        lecture_materials = lecture_materials.OrderByDescending(a => a.content_id).ToList(); // 공지 ID 기준 내림차순
        CalculateTotalPages();
        await LoadPageNumber();
        LoadPagedData();
        StateHasChanged();
    }

    private void SortById() //강의자료 번호 순 정렬
    {
        if (!sortByIDAscending)
        {
            lecture_materials = lecture_materials.OrderByDescending(a => a.content_id).ToList();
        }
        else
        {
            lecture_materials = lecture_materials.OrderBy(a => a.content_id).ToList();
        }

        sortByIDAscending = !sortByIDAscending;
    }

    private void ShowLecMat(LectureMaterial lm)
    {
        NavigationManager.NavigateTo(NavigationManager.Uri + $"/{lm.content_id}");
    }

    private void OpenEditor()
    {
        NavigationManager.NavigateTo(NavigationManager.Uri + $"/0/edit");
    }

    protected override void OnParametersSet() // OninitializedAsync()를 대체함
    {
        lecture_materials = lecture_materials.OrderByDescending(a => a.content_id).ToList();
        sortByIDAscending = true;
    }

    private async Task OnWeekChanged(List<int> week)
    {
        selectedWeek = week;
        await Task.CompletedTask;
    }

    // Pagination.razor에서 currentPage가 변경되면 실행
    private async Task OnPageChanged(int newPage)
    {
        currentPage = newPage;
        await SavePaginationState();
        LoadPagedData();
    }

    /// <summary>
    /// 전체 페이지 수 계산
    /// </summary>
    private void CalculateTotalPages()
    {
        totalPages = (int)Math.Ceiling((double)lecture_materials.Count / pageSize);
    }

    /// <summary>
    /// 현재 페이지의 공지사항 리스트 로딩
    /// </summary>
    private void LoadPagedData()
    {
        paged_lec_mats = lecture_materials.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
    }

    /// <summary>
    /// 세션 스토리지에 현재 페이지 번호를 저장
    /// </summary>
    private async Task SavePaginationState()
    {
        await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "currentPage", currentPage);
    }

    /// <summary>
    /// 세션 스토리지에 저장된 현재 페이지 번호를 로딩
    /// </summary>
    private async Task LoadPageNumber()
    {
        var storedPage = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "currentPage");
        if (!string.IsNullOrEmpty(storedPage)) currentPage = int.Parse(storedPage);
    }
}